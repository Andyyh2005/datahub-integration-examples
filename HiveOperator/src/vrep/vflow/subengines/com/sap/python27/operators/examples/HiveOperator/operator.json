{"description":"hiveOperator","component":"com.sap.system.python2Operator","inports":[{"name":"inSql","type":"string"}],"outports":[{"name":"output","type":"string"}],"icon":"puzzle-piece","iconsrc":"Apache_Hive_logo.svg","config":{"$type":"http://sap.com/vflow/HiveOperator.configSchema.json","database":"default","delimiter":";","hive_hostname":"fqdn.hive.com","http_mode":false,"kerberos_enabled":false,"kerberos_keytab_filename":"vora.keytab","kerberos_principal":"vora","kerberos_realm":"AD.HADOOP","password":"****","port":10000,"script":"from pyhive import hive\nfrom subprocess import call\nimport base64 \nfrom thrift.transport.THttpClient import THttpClient \n\nhostname = api.config.hive_hostname #\"mo-94b6f9888.mo.sap.corp\"\nport = api.config.port\nuser = api.config.username\npassword = api.config.password\ndatabase= api.config.database\nkerberos_enabled = api.config.kerberos_enabled\nkerberos_keytab = \"/keytabs/\" + api.config.kerberos_keytab_filename\nkerberos_principal = api.config.kerberos_principal + \"@\" + api.config.kerberos_realm\nhttp_enabled = api.config.http_mode\n\nif(kerberos_enabled):\n    call([\"cp\",\"/vrep/vflow/dockerfiles/custom/HiveOperator/\"+api.config.kerberos_keytab_filename,\"/keytabs\"])\n    call([\"cp\",\"/vrep/vflow/dockerfiles/custom/HiveOperator/krb5.conf\",\"/etc\"])\n    call([\"/usr/bin/kinit\",\"-kt\",kerberos_keytab, kerberos_principal])\n\ndef on_input(inSql):\n   \n    hiveconnection(inSql)\n\ndef add_http_mode_support(username=user, password=password, port=port, httpPath=\"/cliservice\", host=hostname, transportMode=\"http\"):\n    ap = \"%s:%s\" % (username, password)\n    _transport = THttpClient(host,port=port,path=httpPath)\n    _transport.setCustomHeaders({\"Authorization\": \"Basic \"+base64.b64encode(ap).strip()})\n    return _transport\n    \ndef hiveconnection(inSql):\n    if(kerberos_enabled):\n        auth = \"KERBEROS\"\n        kerberos_service_name = \"hive\"\n        password = None\n    else:\n        password = api.config.password\n        auth = 'CUSTOM'\n        kerberos_service_name = None\n\n    if(http_enabled):\n        conn = hive.connect(thrift_transport=add_http_mode_support()) \n    else:\n        conn = hive.Connection(host=hostname, port=port, username=user,password=password,database=database, auth=auth,kerberos_service_name=kerberos_service_name)\n    \n    cur = conn.cursor()\n    cur.execute(inSql)\n    resultList = cur.fetchall()\n\n    string = \"\"\n    for x in resultList:\n        for y in x:\n            string = string + str(y) + api.config.delimiter ## Delimiter to separate Hive columns in output\n        string = string + \"\\n\"\n\n    api.send(\"output\",string)\n\n\n\napi.set_port_callback(\"inSql\", on_input)","username":"hive"},"tags":{"pyhive":"pip2"}}